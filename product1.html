let finalPrice = 16500;
let discountAmount = 0;
let shippingFee = 0;

function updateShippingFee() {
    const shippingInfo = document.getElementById('shipping-info').value;
    const priceElement = document.getElementById('total-price');
    const shippingFeeElement = document.getElementById('shipping-fee');
    const priceTextElement = document.getElementById('price-text');
    const paypalButtonContainer = document.getElementById('paypal-button-container');
    const inquiryMessage = document.getElementById('inquiry-message');
    
    if (shippingInfo === "本州四国九州") {
        shippingFee = 500;
        finalPrice = 16500 + shippingFee;
    } else if (shippingInfo === "東北") {
        shippingFee = 650;
        finalPrice = 16500 + shippingFee;
    } else if (shippingInfo === "北海道") {
        shippingFee = 700;
        finalPrice = 16500 + shippingFee;
    } else if (shippingInfo === "その他") {
        shippingFee = 550;
        finalPrice = 16500 + shippingFee;
    } else if (shippingInfo === "沖縄" || shippingInfo === "離島" || shippingInfo === "海外") {
        shippingFeeElement.textContent = "配送はできません。";
        inquiryMessage.style.display = "block";
        paypalButtonContainer.style.display = "none";
        return;
    } else {
        shippingFee = 0;
        finalPrice = 16500;
    }

    finalPrice -= discountAmount;

    priceElement.textContent = finalPrice.toLocaleString();
    priceTextElement.textContent = `価格: ¥${finalPrice.toLocaleString()} (税込)`;
    shippingFeeElement.textContent = `送料: ¥${shippingFee}`;

    if (shippingInfo !== "沖縄" && shippingInfo !== "離島" && shippingInfo !== "海外") {
        renderPaypalButton(finalPrice);
    }

    updatePaypalAmount(finalPrice);
}

function renderPaypalButton(finalPrice) {
    const paypalButtonContainer = document.getElementById('paypal-button-container');
    paypalButtonContainer.style.display = "block";
    paypalButtonContainer.innerHTML = '';

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: finalPrice.toString()
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                alert('取引が完了しました。ありがとうございます ' + details.payer.name.given_name);
            });
        }
    }).render('#paypal-button-container');
}

function applyCoupon() {
    const correctCoupon = "DISCOUNT1500";
    const inputCode = document.getElementById("coupon-code").value;
    const messageElement = document.getElementById("coupon-message");

    if (inputCode === correctCoupon) {
        discountAmount = 1500;
        messageElement.textContent = "クーポンが適用されました！";
        messageElement.style.color = "green";
    } else {
        discountAmount = 0;
        messageElement.textContent = "クーポンコードが誤っています";
        messageElement.style.color = "red";
    }

    updateShippingFee();
}

function updatePaypalAmount(newAmount) {
    const existingButton = document.getElementById('paypal-button-container');
    if (existingButton) {
        existingButton.innerHTML = '';
    }

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: newAmount.toString()
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                alert('取引が完了しました。ありがとうございます ' + details.payer.name.given_name);
            });
        }
    }).render('#paypal-button-container');
}
